<p align="center">
  <img src="img/logo.png" alt="Sudoku Golang CLI Logo" width="250"/>
</p>

## Оглавление

* [Описание](#описание)
* [Требования](#требования)
* [Установка и сборка сервиса](#установка-и-сборка-сервиса)
* [Доступные команды](#доступные-команды)
* [Настройка](#настройка)
* [Инфраструктура](#инфраструктура)
    * [Сервисы](#сервисы)
        * [Traefik](#traefik)
        * [Redis (KeyDB)](#redis-keydb)
        * [Elasticsearch](#elasticsearch)
        * [RabbitMQ](#rabbitmq)
    * [Сеть](#сеть)
* [Структура проекта](#структура-проекта)

---

## Описание

Этот проект — CLI-инструмент на Go для управления инфраструктурой и сервисами, связанными с Sudoku, через `docker-compose`. Позволяет удобно собирать, запускать, останавливать и пересобирать контейнеры через набор команд.

## Установка и сборка сервиса

1. Клонируйте репозиторий:

   ```sh
   git clone <URL-репозитория>
   cd sudoku-golang
   ```

2. Создайте файл `.env` в корне проекта и укажите необходимые переменные (см. раздел [Настройка](#настройка)).

3. Запустите скрипт сборки:

   ```sh
   make build
   ```

   Скрипт выполняет следующие действия:

    * Проверяет наличие `.env` и переменной `ROOT_PROJECTS_FOLDER`.
    * Создаёт необходимые папки: `${ROOT_PROJECTS_FOLDER}` и `build`.
    * Собирает бинарник `sudoku` в папку `build`.
    * Копирует бинарник и `.env` в `${ROOT_PROJECTS_FOLDER}`.
    * Копирует папку конфигурации `sudoku-config` и файл `compose.yaml` в `${ROOT_PROJECTS_FOLDER}` (если они ещё не скопированы).

4. После успешного выполнения скрипта бинарник и конфигурация будут готовы к использованию в `${ROOT_PROJECTS_FOLDER}`.

## Доступные команды

Запуск команд производится через бинарник `sudoku` или напрямую через Go:

```sh
./sudoku build       # Собирает все контейнеры
./sudoku start       # Запускает собранные контейнеры
./sudoku stop        # Останавливает все контейнеры
./sudoku forceBuild  # Принудительно собирает контейнеры
./sudoku down        # Останавливает и удаляет все контейнеры
./sudoku restart     # Перезапускает все контейнеры
./sudoku rebuild     # Останавливает, собирает и запускает контейнеры
./sudoku forceRebuild # Принудительно пересобирает контейнеры
```

## Настройка

Конфигурация загружается из `.env` или переменных окружения.

Доступные переменные:

* `DOCKER_PATH` — путь к исполняемому файлу Docker (по умолчанию `/usr/bin/env docker`)
* `DOCKER_COMPOSE_PATH` — путь к Docker Compose (по умолчанию `/usr/bin/env docker compose`)
* `MAX_WORKERS` — количество воркеров (по умолчанию 5)
* `ROOT_PROJECTS_FOLDER` — корневая папка проектов, куда будет скопирован бинарник и конфигурация (обязательно для работы скрипта)

## Инфраструктура

Проект использует Docker Compose для поднятия локальной инфраструктуры, которая необходима для работы CLI-сервиса Sudoku. Все сервисы объединены в отдельную сеть `sudoku_network`.

### Сервисы

#### Traefik

* Версия: `2.9.6`
* Reverse proxy для маршрутизации трафика к другим сервисам.
* Проброшены порты:

    * `8080` — веб-интерфейс Traefik (доступен локально на `127.0.0.1:8080`)
    * `80`, `443`, `5173`, `16379`, `8000`, `25`, `110`, `143`, `465`, `587`, `993`, `995`, `8443`, `8081`, `13306`, `13307`
* Подключение к Docker сокету для автоматического обнаружения контейнеров.
* Конфигурация берётся из:

    * `sudoku-config/traefik/traefik.yaml`
    * `sudoku-config/traefik/custom/`

#### Redis (KeyDB)

* Образ: `eqalpha/keydb:latest`
* Основной сервис для кэширования и хранения данных.
* Проброшен порт `6379` через Traefik TCP маршрутизатор.
* Данные сохраняются в `sudoku-config/redis/data`.
* Пользователь и группа берутся из переменных окружения `DOCKER_UID` и `DOCKER_GID`.

#### Elasticsearch

* Образ: `elasticsearch:7.14.1`
* Служит для хранения и поиска больших объёмов данных.
* Конфигурация:

    * `ES_JAVA_OPTS=-Xms512m -Xmx512m`
    * `discovery.type=single-node`
* Данные сохраняются в `sudoku-config/elasticsearch/data`.
* Проброшен порт `9200` через Traefik TCP маршрутизатор.

#### RabbitMQ

* Образ: `rabbitmq:3.12-management-alpine`
* Служит для обмена сообщениями между сервисами (message broker).
* Проброшены порты:

    * `5672` — основной порт для клиентов
    * `15672` — веб-интерфейс управления RabbitMQ
* Учетные данные по умолчанию:

    * Пользователь: `default`
    * Пароль: `default`

### Сеть

Все сервисы подключены к сети `sudoku_network` с использованием драйвера `bridge`. **IPv6** отключен.

## Структура проекта

```
cmd/                  ── точка входа CLI (main.go)
internal/
├── infra/
│   └── configs/      ── загрузка и обработка конфигов (configs.go)
├── logger/
│   └── logger.go     ── логирование
├── service/
│   └── compose.go    ── работа с Docker Compose и прогресс-барами
└── sudoku/
    ├── commands/     ── команды CLI (build, start, stop, rebuild и др.)
    └── cli.go        ── инициализация и запуск CLI
```